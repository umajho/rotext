# 块级阶段

块级阶段的语法围绕[[#块级元素|块级元素]]展开，相邻的[[#块级元素|块级元素]]会组成[[#块级元素序列|块级元素序列]]。

在[[#适用于块级元素的槽位|适用于块级元素的槽位]]之中，有部分槽位需要填充[[#块级元素序列|块级元素序列]]。借由<wbr />
这些槽位，块级元素之间能够形成层级结构。

## 块级阶段概念一览

### 空行

由任意数量空格（不能是其它空白字符）组成的行。

### 块级阶段对空白字符的处理

[[#块级元素|块级元素]]之间（包括同类之间）的非换行空白字符会被会被无视。

### 块级元素

**<ruby>块级<rt>Block-level</rt></ruby>&#x200B;[[s:通用概念#元素|元素]]**&#x200B;对应于
<wbr /> HTML
之中的块级元素，是[[s:通用概念#文档|文档]]的主干，组织起了[[s:通用概念#文档|文档]]的结构。

### 块级元素序列

**块级元素序列**由一连串相邻的[[#块级元素|块级元素]]组成。

### 适用于块级元素的槽位

根据情况，可以将**适用于块级元素的[[s:通用概念#槽位|槽位]]**（以下简称为
“块级元素槽位”）<wbr /> 能够填充的内容分为以下几类：

- [[#块级元素序列|块级元素序列]]，（包括由特定[[#块级元素|块级元素]]组成的序列，包括：<wbr />
  [[s:块级元素一览/列表#列表项序列|列表项序列]]、[[s:块级元素一览/描述列表#描述列表项序列|描述列表项序列]]、[[s:块级元素一览/表格#表格单元格序列|表格单元格序列]]、<wbr />
  [[s:块级元素一览/表格#表格单元格序列|表格单元格序列]]、[[s:块级元素一览/表格#表格行|表格行]]和两种[[s:块级元素一览/表格#表格单元格|表格单元格]]）
- [[#块级参数|块级参数]]，
- [[s:通用概念#逐字内容|逐字内容]]，
- [[s:行内阶段#行内序列|行内序列]]。

对[[s:行内阶段#行内序列|行内序列]]槽位内容的解析属于[[s:行内阶段|行内阶段]]的工作，其他则仍属于块级阶段。

#### 块级元素槽位的分隔符

块级元素[[s:通用概念#槽位的分隔符|槽位的分隔符]]由内向外就近匹配：

```example
<% 第二处 “||” 适用于 “注”，而非 “折叠”。 %>
{{ #折叠 || {{ #注 || Hi! }} }}
···
<x-collapse>
  <div slot="content">
    <x-callout-note>
      <p>Hi!</p>
    </x-callout-note>
  </div>
</x-collapse>
```

块级元素[[s:通用概念#槽位的分隔符|槽位的分隔符]]可以插在[[s:通用概念#直属|直属]]于它的[[#块级元素|块级元素]]闭合之后：

```example use-fixtures=两个块引用
{{两个块引用 || {{#折叠||foo}} || {{#注||bar}} {{#折叠||baz}}}}
···
<blockquote>
  <x-collapse>
    <div slot="content">
      <p>foo</p>
    </div>
  </x-collapse>
</blockquote>
<blockquote>
  <x-callout-note><p>bar</p></x-callout-note>
  <x-collapse>
    <div slot="content">
      <p>baz</p>
    </div>
  </x-collapse>
</blockquote>
```

```example-fixture name=两个块引用
> {{{1}}}

> {{{2}}}
```

块级元素[[s:通用概念#槽位的分隔符|槽位的分隔符]]可以截断[[s:通用概念#直属|直属]]于它的[[s:块级元素一览/段落|段落]]：

```example use-fixtures=两个块引用
{{两个块引用||吃葡萄||不吐葡萄皮。}}
···
<blockquote><p>吃葡萄</p></blockquote>
<blockquote><p>不吐葡萄皮。</p></blockquote>
```

否则，潜在的分隔符标记（`||`）保持原样：

```example
<% 第二处 “||” 直接包含于块引用之中，并不[[s:通用概念#直属|直属]]于块级扩展 “折叠”，因此保持原样。 %>
{{ #折叠 || > || }}
···
<x-collapse>
  <blockquote><p>||</p></blockquote>
</x-collapse>
```

```example
吃葡萄||不吐葡萄皮。
···
<p>吃葡萄||不吐葡萄皮。</p>
```

#### 块级元素槽位通用的终止界限

块级元素槽位存在多种终止界限：

- 无论是何种块级元素槽位，到达文档结尾时肯定都要终止：

  ```example
  {|
  |-
  || {{#折叠||还没闭合文档就结束了！
  ···
  <table>
    <tr>
      <td>
        <x-collapse>
          <div slot="content">
            <p>还没闭合文档就结束了！</p>
          </div>
        </x-collapse>
      </td>
    </tr>
  </table>
  ```

  ````example
  ```
  代码块没有闭合！
  ···
  <x-code-block info-string="" content="代码块没有闭合！"></x-code-block>
  ````

- 对于有闭合部分或分隔符的块级元素的槽位，到达其所属元素闭合部分或分隔符<wbr />
  时要终止；

- 对于除了[[s:块级元素一览/代码块|代码块]]之外的块级元素槽位，到达其所属元素父级元素的终止界限时要终止：

  ```example
  > 第一段
  第二段
  ···
  <blockquote><p>第一段</p></blockquote>
  <p>第二段</p>
  ```

  ```example
  {|
  |-
  !! 第一段 !! * 列表项中的第二段 !! 因为没换行所以还在列表项中<% 列表项的终止界限在这里。 %>
  !! 第三段
  |}
  ···
  <table>
    <tr>
      <th><p>第一段</p></th>
      <th><ul><li><p>列表项中的第二段 || 因为没换行所以还在列表项中</p></li></ul></th>
      <th><p>第三段</p></th>
    </tr>
  </table>
  ```

  ```example
  {{#折叠|| {|
  |-
  !! 表格没有闭合部分。
  }}
  ···
  <x-collapse>
    <div slot="content">
      <p>表格没有闭合部分。</p>
    </div>
  </x-collapse>
  ```

  - 需要特别注意，对于填充[[s:通用概念#逐字内容|逐字内容]]的块级元素槽位，其所属元素外部元素<wbr />
    的闭合部分于该逐字内容中无效：

    ````example
    {{#折叠||
    ```
    }}
    ```
    ···
    <x-collapse>
      <div slot="content">
        <x-code-block info-string="" content="}}&#10;"></x-code-block>
      </div>
    </x-collapse>
    ````

- 对于[[s:块级元素一览/代码块|代码块]]，若其祖先中存在[[s:块级元素一览/块引用|块引用]]、[[s:块级元素一览/列表|列表]]或[[s:块级元素一览/描述列表|描述列表]]，到达<wbr />
  离其最近上述种类元素的终止界限时要终止：

  ````example
  ; ```
  > 没闭合的代码块
  : ```
  > 另一个没闭合的代码块
  ···
  <dl>
    <dt><x-code-block info-string="" content="没闭合的代码块"></x-code-block></dt>
    <dd><x-code-block info-string="" content="另一个没闭合的代码块"></x-code-block></dd>
  </dl>
  ````

- 此外，许多块级元素有独自的、与父级无关的规则用于确定其槽位的终止界限，<wbr />
  这些规则会在对应元素的章节中说明。

#### 块级参数

**块级参数**是填充进[[s:块级元素一览/块级扩展|块级扩展]]（以及[[s:杂项/画饼/设想中的块级嵌入包含相关/块级嵌入包含|设想中的块级嵌入包含]]）之槽位的参数。

可以是以下三种中的一种：

- [[#块级元素序列|块级元素序列]]
- 任意数量的空白、[[s:通用概念#名称|名称]]、任意数量的空白、`=`、
  任意数量的空白与[[#块级元素序列|块级元素序列]]。
- 任意数量的空白、`` ` ``、[[s:通用概念#名称|名称]]、任意数量的空白、`=`、
  任意数量的空白与[[s:通用概念#逐字内容|逐字内容]]。

### 层

**层**用于界定[[#块级元素|块级元素]]在以[[s:通用概念#文档|文档]]为根部的层级结构中的深度。

一个[[#块级元素|块级元素]]的层数是
“不算那个元素自身，往外数直到文档根部中遇到的<wbr />
[[#块级元素|块级元素]]的个数” + 1。对于位于第 n
层的块级元素，称其[[s:通用概念#槽位|槽位]]的内容是 <wbr /> “位于 n+ 1”
层的内容。
