# 块级阶段

块级阶段的语法围绕[[块级元素]]展开，相邻的[[块级元素]]会组成[[块级元素序列]]。

在[[适用于块级元素的槽位]]之中，有部分槽位需要填充[[块级元素序列]]。借由<wbr />
这些槽位，块级元素之间能够形成层级结构。

## 块级阶段概念一览

### 块级元素

**<ruby>块级<rt>Block-level</rt></ruby>&#x200B;[[元素]]**&#x200B;对应于 <wbr />
HTML 之中的块级元素，是[[文档]]的主干，组织起了[[文档]]的结构。

[[块级扩展]]、[[块级嵌入包含]]与[[块级参数填充]]是比较特殊的块级元素。所<wbr />
有块级元素中，只有这三种不保证渲染得到的最外层一定是一个单独的 HTML 元素。

<!--TODO: 将上述三者单独划分为 “伪块级元素”，与其他块级元素合称 “类块级元素” 之类的？-->

### 块级元素序列

**块级元素序列**由一连串相邻的[[块级元素]]组成。

### 适用于块级元素的槽位

根据情况，可以将**适用于块级元素的[[槽位]]**（以下简称为 “块级元素槽位”）<wbr />
能够填充的内容分为以下几类：

- [[块级元素序列]]，（包括由特定[[块级元素]]组成的序列，包括：<wbr />
  [[列表项序列]]、[[描述列表项序列]]、[[表格单元格序列]]、<wbr />
  [[表格单元格序列]]、[[表格行]]和两种[[表格单元格]]）
- [[块级参数]]，
- [[逐字内容]]，
- [[行内序列]]。

对[[行内序列]]槽位内容的解析属于[[行内阶段]]的工作，其他则仍属于块级阶段。

#### 块级元素槽位的分隔符

块级元素[[槽位的分隔符]]可以插在[[直属]]于它的[[块级元素]]闭合之后，此<wbr />
外，还可以截断[[直属]]于它的[[段落]]：

```example group=块级元素槽位的分隔符
{{两个块引用 || {{#折叠: foo}} || {{#提示: bar}} {{#折叠: baz}}}}
···
<blockquote>
  <x-collapse>
    <div slot="content">
      <p>foo</p>
    </div>
  </x-collapse>
</blockquote>
<blockquote>
  <x-callout><p>bar</p></x-callout>
  <x-collapse>
    <div slot="content">
      <p>baz</p>
    </div>
  </x-collapse>
</blockquote>
```

```example-fixture group=块级元素槽位的分隔符 name=两个块引用
> {{{1}}}

> {{{2}}}
```

```example group=块级元素槽位的分隔符
{{两个块引用||吃葡萄||不吐葡萄皮。}}
···
<blockquote><p>吃葡萄</p></blockquote>
<blockquote><p>不吐葡萄皮。</p></blockquote>
```

```example
<% “||” 适用于 “提示”，而非 “折叠”。 %>
{{#折叠: {{#提示: 类型=信息 || Hi!}} }}
···
<x-collapse>
  <div slot="content">
    <p>Hi!</p>
  </div>
</x-collapse>
```

若不满足上述条件，潜在分隔符标记保持原样（在预览期间呈现警告）：

```example
<% 最右侧的 “||” 直接包含于块引用之中，不适用于块级扩展 “提示”，因此保持原样。 %>
{{#提示: 类型=信息 || > ||}}
···
<x-callout type="info">
  <blockquote><p><x-preview-warn type="potential-block-level-separator">||</x-preview-warn></p></blockquote>
</x-callout>
```

```example
吃葡萄||不吐葡萄皮。
···
<p>吃葡萄<x-preview-warn type="potential-block-level-separator">||</x-preview-warn>不吐葡萄皮。</p>
```

#### 块级元素槽位通用的终止界限

块级元素槽位存在多种终止界限：

- 无论是何种块级元素槽位，到达文档结尾时肯定都要终止：

  ```example
  {|
  |-
  || {{#折叠: 还没闭合文档就结束了！
  ···
  <table>
    <tr>
      <td>
        <x-collapse>
          <div slot="content">
            <p>还没闭合文档就结束了！</p>
          </div>
        </x-collapse>
      </td>
    </tr>
  </table>
  ```

  ````example
  ```
  代码块没有闭合！
  ···
  <pre><code>代码块没有闭合！</code></pre>
  ````

- 对于有闭合部分或分隔符的块级元素的槽位，到达其所属元素闭合部分或分隔符<wbr />
  时要终止；

- 对于除了[[代码块]]之外的块级元素槽位，到达其所属元素父级元素的终止界限时要终止：

  ```example
  > 第一段
  第二段
  ···
  <blockquote><p>第一段</p></blockquote>
  <p>第二段</p>
  ```

  ```example
  {|
  |-
  !! 第一段 !! * 列表项中的第二段 !! 因为没换行所以还在列表项中<% 块引用的终止界限在这里。 %>
  !! 第三段
  |}
  ···
  <table>
    <tr>
      <th><p>第一段</p></th>
      <th><ul><li><p>列表项中的第二段 <x-preview-warn type="potential-table-cell-markup">||</x-preview-warn> 因为没换行所以还在列表项中</p></li></ul></th>
      <th><p>第三段</p></th>
    </tr>
  </table>
  ```

  ```example
  {{#折叠: {|
  |-
  !! 表格没有闭合部分。
  }}
  ···
  <x-collapse>
    <div slot="content">
      <p>表格没有闭合部分。</p>
    </div>
  </x-collapse>
  ```

  - 需要特别注意，对于填充[[逐字内容]]的块级元素槽位，其所属元素外部元素<wbr />
    的闭合部分于该逐字内容中无效：

    ````example
    {{#折叠:
    ```
    }}
    ```
    ···
    <x-collapse>
      <div slot="content">
        <pre><code>}}</code></pre>
      </div>
    </x-collapse>
    ````

- 对于[[代码块]]，若其祖先中存在[[块引用]]、[[列表]]或[[描述列表]]，到达<wbr />
  离其最近上述种类元素的终止界限时要终止：

  ````example
  ; ```
  > 没闭合的代码块
  : ```
  > 另一个没闭合的代码块
  ···
  <dl>
    <dt><pre><code>没闭合的代码块</code></pre></dt>
    <dd><pre><code>另一个没闭合的代码块</code></pre></dd>
  </dl>
  ````

- 此外，许多块级元素有独自的、与父级无关的规则用于确定其槽位的终止界限，<wbr />
  这些规则会在对应元素的章节中说明。

#### 块级参数

**块级参数**是用于为[[块级嵌入包含]]或[[块级扩展]]提供参数的槽位。

- 分隔符：`||`；
- 开启：（[[块级嵌入包含]]或[[块级扩展]]的可变槽位的开<wbr />
  头之后，以及分隔符之后）；
  - 之后可选：任意数量的空白、剪除首尾空白后作为参数名称的单行<wbr />
    [[逐字内容]]、任意数量的空白、`=` 与任意数量的空白。
- [[块级元素槽位通用的终止界限|通用]]之外的终止界限：分隔符之前；
- 槽位：其开启部分与闭合部分之间，填充[[块级元素序列]]。

### 层

**层**用于界定[[块级元素]]在以[[文档]]为根部的层级结构中的深度。

一个[[块级元素]]的层数是 “不算那个元素自身，往外数直到文档根部中遇到的<wbr />
[[块级元素]]的个数” + 1。对于位于第 n 层的块级元素，称其[[槽位]]的内容是 <wbr />
“位于 n+ 1” 层的内容。
